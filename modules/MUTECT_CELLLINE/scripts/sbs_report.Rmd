---
title: "SBS Filtering and QC Report"
author: "Luka Culibrk"
date: "2024-05-03"
output: 
    pdf_document:
        keep_md: true
params:
  args: ''
---

```{r setup, include=FALSE}
library(data.table)
library(ggplot2)
library(cowplot)
library(viridis)
library(stringr)
set.seed(42069)


## Eventually have this table be read in from disk
conversion_table = c("NCI-H1650" = "H1650", 
										 "NCI-H2347" = "H2347", 
										 "PC-14"			 = "PC9")

require(BSgenome.Hsapiens.UCSC.hg19)
plot_variants = function(dat){
	complement = c("A" = "T", "C" = "G", "T" = "A", "G" = "C")
	mutated_base = c("C", "T")
	trinucs = rep("", times = 96)
	it = 1
	for(i in 1:4){
		base1 = complement[i]
		for(j in 1:2){
			base2 = mutated_base[j]
			poss = complement[complement!=base2]
			for(k in 1:4){
				base3 = complement[k]
				for(l in 1:3){
					change = poss[l]
					trinucs[it] = paste0(base1, base2, base3, ">", change)
					it = it+1
				}
			}
		}
	}
	trinucs_blank = data.table(trinuc = tstrsplit(trinucs, ">")[[1]], change = tstrsplit(trinucs, ">")[[2]])
	sbs_palette = c("C>A" = "#23c9f2",
									"C>G" = "#000000",
									"C>T" = "#eb4030",
									"T>A" = "#d4d3d3",
									"T>C" = "#afd476",
									"T>G" = "#f2d3d1")
	
	dat = dat[nchar(REF) == 1 & nchar(ALT) == 1]
	dat[,CHROM := paste0("chr", CHROM)]
	dat[,up:=POS-1]
	dat[,down:=POS+1]
	gr = makeGRangesFromDataFrame(df = dat, seqnames.field = "CHROM", start.field = "POS", end.field = "POS")
	mutpos = getSeq(BSgenome.Hsapiens.UCSC.hg19, gr)
	flip = which(data.table(data.frame(mutpos))$mutpos %in% c("G", "A"))
	dat[,strand:="+"]
	dat[flip,strand:="-"]
	gr = makeGRangesFromDataFrame(df = dat, seqnames.field = "CHROM", start.field = "up", end.field = "down")
	trinucs = getSeq(BSgenome.Hsapiens.UCSC.hg19, gr)
	dat$trinuc = as.character(trinucs)
	dat[,comp_alt:=ALT]
	dat[strand == "-",comp_alt:=complement[ALT]]
	
	catalog = dat[,c("trinuc", "comp_alt")]
	catalog = catalog[,.N, by = c("trinuc", "comp_alt")]
	catalog[order(comp_alt, trinuc)]
	
	setkey(catalog, trinuc, comp_alt)
	## Fill in to 96
	catalog = catalog[trinucs_blank]
	catalog[,ref:=substr(trinuc, 2, 2)]
	catalog = catalog[order(ref, comp_alt, trinuc)]
	catalog[is.na(N)]$N = 0
	catalog[,xticks:=paste0(trinuc, comp_alt)]
	catalog[,xticks:=factor(xticks, levels = xticks)]
	catalog[,change:=paste0(ref, ">", comp_alt)]
	p = ggplot(catalog, aes(x = xticks, y = N, fill = change)) + geom_bar(stat = "identity", width = 0.6) + scale_fill_manual(values = sbs_palette) + 
		scale_x_discrete(labels = catalog$trinuc) + 
		theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5), legend.position = "none", panel.grid.minor = element_blank(), panel.grid.major.x = element_blank()) +
		xlab("Trinucleotide Context") + ylab("SBS count")
	return(p)
}
```

## Code to read the data

```{r}
args = params$args
tbl = fread(args["daughter"], header = F)
names(tbl) = c("std_path", "germ_path", "name", "line", "cell")
tbl[,analysis_path:=dirname(dirname(std_path))]
```

## Cell line of origin QC

We show heatmaps for quick visualization as well as show a list of the unique top matches for each cell group.

```{r cell_line_of_origin, fig.height=20, fig.width=14, out.width="100%"}
cell_lines = unique(tbl$cell)
identity_qc_results = lapply(1:nrow(tbl), function(x){
		path = tbl$analysis_path[x]
		qc_path = paste0(path, "/proc/line_of_origin.txt")
		tab = fread(qc_path)
		tab$name = tbl$name[x]
		return(tab)
})

tops = lapply(identity_qc_results, function(x){x[1]$line})

for(i in cell_lines){
	inds = which(tbl$cell == i)
	message(paste0("All top hits for samples from cell line ", i, ":"))
	print(unique(unlist(tops[inds])))
}


identity_qc_results = rbindlist(identity_qc_results)

identity_qc_results[line %in% names(conversion_table),line:=conversion_table[line]]

cell_lines_plots = lapply(cell_lines, function(x){
	ggplot(identity_qc_results[name %in% tbl[cell == x]$name], aes(x = name, y = line, fill = distance)) + geom_tile() + scale_fill_viridis(name = "Mutational\nDistance", direction = -1) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) + ggtitle(paste0("Validating cell-line-of-origin of ", x, " cells")) + scale_y_discrete(breaks = x) + xlab("Sequenced Samples") + ylab("Reference Cell Lines")
})

invisible(capture.output(print(cell_lines_plots)))

```

## Parent/lineage of origin validation

Here we QC based on parent-daughter unique mutation agreement. We already generated the similarity values as part of the collective processing script. Here we plot the results.

```{r parent_of_origin, fig.width=12, fig.height=12}
poo_qc_results = lapply(1:nrow(tbl), function(x){
		path = tbl$analysis_path[x]
		qc_path = paste0(path, "/proc/parent_of_origin.txt")
		tab = fread(qc_path)
		tab$name = tbl$name[x]
		return(tab)
})

for(i in cell_lines){
	inds = which(tbl$cell == i)
	res = rbindlist(poo_qc_results[inds])
	print(ggplot(res, aes(x = Var1, y = Var2, fill = sim)) + geom_tile() + scale_fill_viridis(name = "Proportion of high-quality\nprivate parental mutations\nin daughters") + xlab("Daughter name") + ylab("Parent name") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) + ggtitle(paste0("Parent-daughter matching for cell line ", i)))
}

```

## Filtering summary for each daughter clone

```{r mutation_filtering_summary, fig.width=12, fig.height=9}
variant_data = lapply(1:nrow(tbl), function(x){
		path = tbl$analysis_path[x]
		dat_path = paste0(path, "/proc/variants_headered.txt")
		tab = fread(cmd = paste("grep -v", "mutect_filtered", dat_path))[tumor.LAB != "mutect_filtered"]
		tab$name = tbl$name[x]
		return(tab)
})

variant_data = rbindlist(variant_data)

long_label_descriptions = c("depth" = "Insufficient parental depth (<15x) (FAIL)", "shared_parental" = "Mutation present in >50% parents (FAIL)", "shared_external" = "Mutation present in other non-lineage daughters (FAIL)", "shared_lineage" = "Mutation present in the same lineage (PASS)", "unq" = "Mutation is private (PASS)")

long_label_wrap = stringr::str_wrap(long_label_descriptions, width = 20)

variant_data[,tumor.LAB:=factor(tumor.LAB, levels = c("depth", "shared_parental", "shared_external", "shared_lineage", "unq"))]

for(i in cell_lines){
		print(ggplot(variant_data[name %in% tbl[cell == i]$name], aes(x = name, fill = tumor.LAB)) + geom_bar() + scale_fill_discrete(labels = long_label_wrap, name = "Mutation Category") + xlab("Sample") + ylab("SBS Count") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) + ggtitle(paste0("Filtering of mutations for cell line ", i)))
}

```

## Now we break down justifications for each category. We skip the parental depth because this filter is fairly common sense as it applies to our ability to detect parental mutations. 

### Category "Mutation present in >50% parents"

```{r parental_mutation_filter, fig.width = 8}
for(i in cell_lines){
	print(plot_variants(variant_data[name %in% tbl[cell == i]$name][tumor.LAB == "shared_parental"]) + ggtitle(paste0("Mutation profile of ", i, " daughter SBSs found in >50% of parents")))
}
```

### Category "Mutation present in other non-lineage daughters"

```{r non_lineage_daughters, fig.width=8}
for(i in cell_lines){
	print(plot_variants(variant_data[name %in% tbl[cell == i]$name][tumor.LAB == "shared_external"]) + ggtitle(paste0("Mutation profile of ", i, " daughter SBSs shared between different lineages")))
}
```

### Category "Mutation present in the same lineage" (ie. between sisters only), which we intend to keep

```{r shared_same_lineage, fig.width=8}
for(i in cell_lines){
	print(plot_variants(variant_data[name %in% tbl[cell == i]$name][tumor.LAB == "shared_lineage"]) + ggtitle(paste0("Mutation profile of ", i, " daughter SBSs shared within the same lineage")))
}
```

### Mutation profiles of private mutations. These should be similar to the previous set.

```{r private_mutations, fig.width=8}
for(i in cell_lines){
	print(plot_variants(variant_data[name %in% tbl[cell == i]$name][tumor.LAB == "unq"]) + ggtitle(paste0("Mutation profile of private ", i, " daughter SBSs")))
}
```

## Final mutation profiles of each cell type aggregated

```{r final_profiles_by_cell_type, fig.width=8}

for(i in cell_lines){
	print(plot_variants(variant_data[name %in% tbl[cell == i]$name][FILTER == "PASS"]) + ggtitle(paste0("Mutation profile of passing ", i, " SBS mutations")))
}

```

## Individual mutational profiles of daughter cells (this is a lot of plots)

```{r final_mutational_profiles_samples, fig.width=8}
for(i in unique(tbl$name)){
	print(plot_variants(variant_data[name == i][FILTER == "PASS"]) + ggtitle(paste0("Mutation profile of passing ", i, " SBS mutations")))
}

```
